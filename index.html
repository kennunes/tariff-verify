import React, { useState, useEffect, useRef } from 'react';
import { 
  Zap, 
  FileText, 
  Upload, 
  RefreshCcw, 
  Settings, 
  AlertCircle, 
  Loader2, 
  PieChart, 
  Calculator, 
  X, 
  CheckCircle2,
  Info,
  ArrowRight,
  Sun,
  Moon
} from 'lucide-react';

/**
 * Solar Invoice Auditor (Phase 1 Standalone) - Enhanced with Day/Night Mode
 * - Focused exclusively on Municipal Tariff Extraction.
 * - Uses Gemini Vision API for high-precision OCR and analysis.
 * - Hydration-safe theme switching for Vercel stability.
 */

const CURRENCY_SYMBOL = "R";

const App = () => {
  const fileInputRef = useRef(null);

  // --- UI & Configuration State ---
  const [isDarkMode, setIsDarkMode] = useState(true);
  const [apiKey, setApiKey] = useState("");
  const [isConfigOpen, setIsConfigOpen] = useState(false);
  const [isMounted, setIsMounted] = useState(false);
  const [notification, setNotification] = useState(null);
  
  // --- Audit State ---
  const [file, setFile] = useState(null);
  const [base64Data, setBase64Data] = useState(null);
  const [mimeType, setMimeType] = useState("");
  const [isAuditing, setIsAuditing] = useState(false);
  const [error, setError] = useState(null);
  const [auditResults, setAuditResults] = useState(null);

  // Hydration Gate & Settings persistence
  useEffect(() => {
    setIsMounted(true);
    if (typeof window !== 'undefined') {
      const storedKey = localStorage.getItem('solar_audit_api_key');
      if (storedKey) setApiKey(storedKey);
      
      const storedTheme = localStorage.getItem('solar_audit_theme');
      if (storedTheme === 'light') setIsDarkMode(false);
    }
  }, []);

  // Persist theme choice
  useEffect(() => {
    if (isMounted) {
      localStorage.setItem('solar_audit_theme', isDarkMode ? 'dark' : 'light');
    }
  }, [isDarkMode, isMounted]);

  const handleFileUpload = (e) => {
    const uploadedFile = e.target.files[0];
    if (!uploadedFile) return;

    if (uploadedFile.size > 4 * 1024 * 1024) {
      setError("File too large. Please upload a document under 4MB.");
      return;
    }

    setFile(uploadedFile);
    const reader = new FileReader();
    reader.onload = (event) => {
      if (event.target && event.target.result) {
        const resultString = event.target.result.toString();
        const b64 = resultString.split(',')[1];
        setBase64Data(b64);
        setMimeType(uploadedFile.type || 'image/png');
        setError(null);
      }
    };
    reader.onerror = () => setError("Failed to read file.");
    reader.readAsDataURL(uploadedFile);
  };

  const runAudit = async () => {
    if (!apiKey) {
      setError("API Key missing. Click the settings icon to configure.");
      return;
    }
    if (!base64Data) return;

    setIsAuditing(true);
    setError(null);

    const prompt = `Analyze this municipal utility bill for a school and extract:
    1. Billing Month
    2. Total Consumption (kWh)
    3. Total Amount Due (Currency: R)
    4. Detailed Cost Breakdown (Energy Charges, Fixed Fees, VAT, Levies)
    
    Return ONLY JSON: { 
      "utility_type": "Electricity",
      "total_consumption": number, 
      "unit": "kWh",
      "total_amount_due": number, 
      "currency": "R", 
      "billing_month": string,
      "billing_period": string, 
      "cost_breakdown": [
        {"category": string, "amount": number}
      ] 
    }`;

    try {
      const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          contents: [{
            role: "user",
            parts: [{ text: prompt }, { inlineData: { mimeType, data: base64Data } }]
          }],
          generationConfig: { responseMimeType: "application/json" }
        })
      });

      const data = await response.json();
      if (data.error) throw new Error(data.error.message);

      const rawText = data.candidates?.[0]?.content?.parts?.[0]?.text;
      if (!rawText) throw new Error("Document analysis failed. Ensure text is clear.");

      const cleanJson = rawText.replace(/```json/g, "").replace(/```/g, "").trim();
      const results = JSON.parse(cleanJson);
      
      if (!results.total_consumption || !results.total_amount_due) {
        throw new Error("Could not find total consumption or amount due.");
      }

      setAuditResults(results);
      setNotification("Invoice Audited Successfully");
    } catch (err) {
      console.error("Audit failure:", err);
      setError(`Audit Failed: ${err.message || "Unknown error"}`);
    } finally {
      setIsAuditing(false);
    }
  };

  const resetAudit = () => {
    setAuditResults(null);
    setFile(null);
    setBase64Data(null);
    setError(null);
  };

  if (!isMounted) return null;

  return (
    <div className={`min-h-screen transition-colors duration-500 font-sans p-4 md:p-8 ${isDarkMode ? 'bg-[#020617] text-slate-200' : 'bg-slate-50 text-slate-800'}`}>
      {/* Header */}
      <header className="max-w-4xl mx-auto mb-12 flex justify-between items-center">
        <div className="flex items-center gap-4">
          <div className="p-3 bg-lime-500 rounded-2xl shadow-lg shadow-lime-500/20 text-white">
            <Zap className="w-6 h-6" />
          </div>
          <div>
            <h1 className={`text-xl font-black tracking-tight uppercase ${isDarkMode ? 'text-white' : 'text-slate-900'}`}>Phase 1: Invoice Auditor</h1>
            <p className="text-slate-500 text-[10px] font-bold uppercase tracking-widest">Baseline Tariff Extraction</p>
          </div>
        </div>
        
        <div className="flex items-center gap-2">
          <button 
            onClick={() => setIsDarkMode(!isDarkMode)}
            className={`p-3 rounded-2xl border transition-all ${isDarkMode ? 'border-slate-800 bg-slate-800/50 text-yellow-400' : 'border-slate-200 bg-white text-slate-600 shadow-sm'}`}
          >
            {isDarkMode ? <Sun className="w-5 h-5" /> : <Moon className="w-5 h-5" />}
          </button>
          <button 
            onClick={() => setIsConfigOpen(true)} 
            className={`p-3 rounded-2xl border transition-all ${apiKey ? 'border-lime-500/20 bg-lime-500/5 text-lime-500' : isDarkMode ? 'border-slate-800 bg-slate-800/50 text-slate-500' : 'border-slate-200 bg-white text-slate-400 shadow-sm'}`}
          >
            <Settings className="w-5 h-5" />
          </button>
        </div>
      </header>

      <main className="max-w-4xl mx-auto">
        {!auditResults ? (
          <div className={`border rounded-[2.5rem] p-8 md:p-16 shadow-xl transition-all duration-500 ${isDarkMode ? 'bg-slate-900/40 border-white/5' : 'bg-white border-slate-200'}`}>
            <div className="text-center mb-12">
              <h2 className={`text-3xl font-black mb-3 ${isDarkMode ? 'text-white' : 'text-slate-900'}`}>Audit Municipal Baseline</h2>
              <p className="text-slate-500 text-sm max-w-md mx-auto">Upload a recent municipal bill to extract your school's current energy cost baseline.</p>
            </div>

            {!file ? (
              <div 
                className={`group border-2 border-dashed rounded-3xl p-16 cursor-pointer text-center transition-all duration-300 ${isDarkMode ? 'border-slate-800 bg-slate-950/50 hover:border-lime-500/40' : 'border-slate-200 bg-slate-50 hover:border-lime-500 hover:bg-lime-50'}`}
                onClick={() => fileInputRef.current?.click()}
              >
                <input ref={fileInputRef} type="file" hidden onChange={handleFileUpload} accept="image/*,application/pdf" />
                <Upload className="w-12 h-12 text-slate-400 group-hover:text-lime-500 mx-auto mb-4 transition-colors" />
                <p className={`font-black text-lg ${isDarkMode ? 'text-white' : 'text-slate-800'}`}>Drop Invoice Scan Here</p>
                <p className="text-slate-500 text-xs font-medium mt-2">PDF, PNG, or JPEG (Max 4MB)</p>
              </div>
            ) : (
              <div className="space-y-6">
                <div className={`flex items-center gap-4 p-5 rounded-2xl border ${isDarkMode ? 'border-lime-500/10 bg-lime-500/5' : 'border-lime-100 bg-lime-50/50'}`}>
                  <div className="p-3 bg-lime-500 text-white rounded-xl">
                    <FileText className="w-6 h-6" />
                  </div>
                  <div className="flex-1 truncate">
                    <p className={`text-sm font-black truncate ${isDarkMode ? 'text-white' : 'text-slate-900'}`}>{file.name}</p>
                    <p className="text-[10px] text-slate-500 font-bold uppercase">Ready for Analysis</p>
                  </div>
                  <button onClick={() => setFile(null)} className="p-2 text-slate-400 hover:text-red-500 transition-colors">
                    <RefreshCcw className="w-5 h-5" />
                  </button>
                </div>

                {error && (
                  <div className="p-4 bg-red-500/10 border border-red-500/20 rounded-2xl text-red-400 text-xs font-bold flex gap-3 items-center">
                    <AlertCircle className="w-4 h-4 shrink-0" />
                    <span>{error}</span>
                  </div>
                )}

                <button 
                  onClick={runAudit} 
                  disabled={isAuditing} 
                  className={`w-full py-5 rounded-3xl font-black text-xs uppercase tracking-widest shadow-xl flex items-center justify-center gap-3 active:scale-95 transition-all disabled:opacity-50 disabled:cursor-not-allowed ${isDarkMode ? 'bg-white text-black hover:bg-lime-500 hover:text-white' : 'bg-slate-900 text-white hover:bg-lime-600'}`}
                >
                  {isAuditing ? (
                    <><Loader2 className="w-5 h-5 animate-spin"/> Processing Document...</>
                  ) : (
                    <>Run AI Audit <ArrowRight className="w-5 h-5"/></>
                  )}
                </button>
              </div>
            )}
          </div>
        ) : (
          <div className="grid grid-cols-1 lg:grid-cols-12 gap-8 animate-in fade-in slide-in-from-bottom-4 duration-700">
            {/* Breakdown Column */}
            <div className="lg:col-span-8 space-y-6">
              <div className={`border rounded-[2rem] p-8 shadow-xl ${isDarkMode ? 'bg-slate-900/40 border-white/5' : 'bg-white border-slate-200'}`}>
                <div className="flex justify-between items-center mb-10">
                  <h3 className="text-xs font-black uppercase text-slate-500 tracking-widest flex items-center gap-2">
                    <PieChart className="w-4 h-4 text-lime-500" /> Audited Bill Breakdown
                  </h3>
                  <div className={`px-4 py-1.5 rounded-full text-[10px] font-black uppercase ${isDarkMode ? 'bg-white/5 text-slate-400' : 'bg-slate-100 text-slate-500'}`}>
                    {auditResults.billing_month} Cycle
                  </div>
                </div>

                <div className="space-y-8">
                  {auditResults.cost_breakdown.map((item, i) => {
                    const pct = (item.amount / auditResults.total_amount_due) * 100;
                    return (
                      <div key={i} className="space-y-2">
                        <div className="flex justify-between text-[11px] font-black uppercase">
                          <span className="text-slate-500">{item.category}</span>
                          <span className={isDarkMode ? 'text-white' : 'text-slate-900'}>{CURRENCY_SYMBOL}{item.amount.toLocaleString()}</span>
                        </div>
                        <div className={`h-2 rounded-full overflow-hidden ${isDarkMode ? 'bg-slate-800' : 'bg-slate-100'}`}>
                          <div 
                            className="h-full bg-lime-500 transition-all duration-1000 ease-out" 
                            style={{ width: `${pct}%` }}
                          ></div>
                        </div>
                      </div>
                    );
                  })}
                </div>

                <div className={`mt-12 p-6 rounded-2xl border flex gap-4 ${isDarkMode ? 'bg-white/5 border-white/5' : 'bg-slate-50 border-slate-100'}`}>
                  <Info className="w-5 h-5 text-slate-400 shrink-0 mt-0.5" />
                  <p className="text-[11px] text-slate-500 font-medium leading-relaxed">
                    This data establishes your <span className={isDarkMode ? 'text-white font-bold' : 'text-slate-900 font-bold'}>Baseline Municipal Liability</span>. Phase 2 will use this to calculate the avoidance value for every solar unit generated.
                  </p>
                </div>
              </div>
            </div>

            {/* Baseline Result Column */}
            <div className="lg:col-span-4 space-y-6">
              <div className="bg-lime-600 rounded-[2rem] p-8 text-white shadow-xl shadow-lime-500/20 flex flex-col justify-between aspect-square lg:aspect-auto">
                <div>
                  <div className="flex items-center gap-2 mb-2">
                    <Calculator className="w-4 h-4 opacity-60" />
                    <p className="text-[10px] font-black uppercase tracking-[0.2em] opacity-60">Calculated Rate</p>
                  </div>
                  <h4 className="text-5xl font-black tracking-tighter mb-4">
                    {CURRENCY_SYMBOL}{(auditResults.total_amount_due / auditResults.total_consumption).toFixed(2)}
                    <span className="text-xs font-bold opacity-50 ml-1 uppercase">/ kWh</span>
                  </h4>
                  <p className="text-[11px] font-bold leading-tight opacity-90 uppercase">
                    This is your blended municipal rate (incl. VAT & Fixed Fees).
                  </p>
                </div>
                
                <div className="pt-8 border-t border-white/10">
                  <p className="text-[10px] font-black uppercase opacity-60 mb-2">Cycle Consumption</p>
                  <p className="text-2xl font-black">{auditResults.total_consumption.toLocaleString()} <span className="text-xs">kWh</span></p>
                </div>
              </div>

              <div className={`border rounded-[2rem] p-6 shadow-sm ${isDarkMode ? 'bg-slate-900/40 border-white/5' : 'bg-white border-slate-200'}`}>
                <button 
                  disabled
                  className={`w-full py-4 mb-4 rounded-2xl font-black text-[10px] uppercase tracking-widest flex items-center justify-center gap-2 cursor-not-allowed ${isDarkMode ? 'bg-white/5 text-slate-600' : 'bg-slate-100 text-slate-400'}`}
                >
                  Continue to Phase 2 (Locked)
                </button>
                <button 
                  onClick={resetAudit}
                  className="w-full text-[10px] font-black uppercase text-slate-400 hover:text-red-500 transition-colors"
                >
                  Clear and Reset Audit
                </button>
              </div>
            </div>
          </div>
        )}
      </main>

      {/* Configuration Modal */}
      {isConfigOpen && (
        <div className="fixed inset-0 z-[100] bg-slate-950/80 backdrop-blur-md flex items-center justify-center p-4">
          <div className={`p-8 rounded-[2.5rem] max-w-sm w-full shadow-2xl border ${isDarkMode ? 'bg-slate-900 border-white/10' : 'bg-white border-slate-100'}`}>
            <div className="flex justify-between items-center mb-8">
              <h3 className={`text-sm font-black uppercase tracking-widest ${isDarkMode ? 'text-white' : 'text-slate-900'}`}>Config</h3>
              <button onClick={() => setIsConfigOpen(false)} className="p-1 hover:bg-slate-100 rounded-lg transition-colors"><X className="w-5 h-5 text-slate-400"/></button>
            </div>
            
            <div className="mb-8">
              <label className="text-[10px] font-black text-slate-400 uppercase block mb-2 tracking-widest">Gemini API Key</label>
              <input 
                type="password" 
                value={apiKey} 
                onChange={(e) => setApiKey(e.target.value)} 
                placeholder="Enter API Key"
                className={`w-full border rounded-2xl py-3 px-4 text-xs outline-none focus:ring-2 focus:ring-lime-500 transition-all ${isDarkMode ? 'bg-black border-white/10 text-white' : 'bg-slate-50 border-slate-200 text-slate-900'}`} 
              />
              <p className="text-[9px] text-slate-400 mt-2 italic font-medium leading-relaxed">Your key is stored locally in your browser and never sent to our servers.</p>
            </div>

            <button 
              onClick={() => { 
                localStorage.setItem('solar_audit_api_key', apiKey); 
                setIsConfigOpen(false); 
                setNotification("API Key Saved");
              }} 
              className="w-full py-4 bg-lime-500 text-white font-black uppercase text-[11px] tracking-widest rounded-2xl shadow-lg hover:bg-lime-600 transition-all"
            >
              Save Configuration
            </button>
          </div>
        </div>
      )}

      {/* Toast Notification */}
      {notification && (
        <div className="fixed bottom-6 right-6 z-[200] max-w-sm w-full animate-in slide-in-from-bottom-5 duration-500">
           <div className={`p-4 rounded-2xl shadow-2xl flex items-center justify-between gap-4 border transition-colors ${isDarkMode ? 'bg-slate-900 border-lime-500/20 text-white' : 'bg-white border-slate-700 text-slate-900'}`}>
             <div className="flex items-center gap-3">
                <CheckCircle2 className="w-5 h-5 text-lime-400" />
                <span className="text-xs font-bold leading-tight">{notification}</span>
             </div>
             <button onClick={() => setNotification(null)} className="p-1 hover:bg-slate-100 rounded-lg transition-colors">
               <X className="w-4 h-4 text-slate-400" />
             </button>
           </div>
        </div>
      )}
    </div>
  );
};

export default App;